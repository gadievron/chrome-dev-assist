# CI/CD Validation Fix Plan - 2025-10-28

**Status**: Planning Phase
**Approach**: Surgical fixes, persona validation, test-first methodology

---

## ✅ PASSING Checks (No Action Needed)

- [x] ShellCheck - Shell script linting
- [x] Hook Security Audit (CVE-2025-53773) - Command injection patterns
- [x] Gitleaks - Secret scanning
- [x] Lint Code (ESLint + Prettier) - JavaScript linting

**Result**: Shell security hardening 100% successful!

---

## ❌ FAILING Checks (Requires Fixes)

### Issue 1: YAML Lint Failures - 2 ERRORS, 8 warnings

**Files Affected**:

- `.github/workflows/codeql.yml`
- `.github/workflows/test-coverage.yml`
- `.github/workflows/critical-checks.yml`
- `.github/workflows/pr-title-check.yml`
- `.github/workflows/labeler.yml`
- `.github/workflows/lint.yml`

#### ERROR 1: Indentation in codeql.yml:29

```yaml
# Current (line 29):
    - cron: '0 9 * * 1'  # INCORRECT: 4 spaces
# Expected:
      - cron: '0 9 * * 1'  # CORRECT: 6 spaces
```

#### ERROR 2: Indentation in test-coverage.yml:22

```yaml
# Current (line 22):
    - 'README.md'  # INCORRECT: 4 spaces
# Expected:
      - 'README.md'  # CORRECT: 6 spaces
```

#### WARNINGS (8 total):

1. Truthy values (6 files) - `on:` should be `true` or quoted `'on'`
2. Line length (2 lines) - Lines exceed 120 characters

**Priority**: HIGH (blocks CI/CD)
**Estimated Time**: 15 minutes
**Risk**: LOW (simple indentation fixes)

---

### Issue 2: Token Budget Validation - CLAUDE.md Too Large

**File**: `CLAUDE.md`
**Current**: 602 lines
**Maximum**: 250 lines
**Overage**: 352 lines (241% over limit)

**Priority**: HIGH (blocks CI/CD)
**Estimated Time**: 45 minutes
**Risk**: MEDIUM (requires careful content splitting)

**Recommended Solution**:
Split CLAUDE.md into focused files:

1. Keep `CLAUDE.md` (100-150 lines) - Quick reference only
2. Create `docs/DEVELOPMENT-GUIDE.md` - Development workflow
3. Create `docs/ARCHITECTURE-OVERVIEW.md` - Architecture details
4. Create `docs/PHANTOM-APIS.md` - Phantom API warnings
5. Create `docs/KNOWN-ISSUES.md` - Known issues/warnings

---

## Surgical Fix Plan

### Phase 1: YAML Lint Fixes (SMALL Task)

**Task Size**: SMALL (2 files, 2 lines)

#### Pre-Flight Checklist

- [ ] Read both affected files completely
- [ ] Verify current indentation levels
- [ ] Check YAML syntax validator locally
- [ ] Identify exact line numbers

#### Fix Checklist

- [ ] Fix codeql.yml:29 indentation (4→6 spaces)
- [ ] Fix test-coverage.yml:22 indentation (4→6 spaces)
- [ ] Run local YAML validation: `yamllint .github/workflows/`
- [ ] Git diff to verify only indentation changed

#### Persona Validation

- [ ] **Developer**: Changes are minimal and surgical
- [ ] **QA**: No functionality changed, syntax only
- [ ] **Logic**: Indentation matches YAML spec
- [ ] **Vulnerability Researcher**: No security implications

#### Completion Gates

- [ ] YAML syntax valid locally
- [ ] Only 2 lines modified
- [ ] Git diff shows only whitespace changes
- [ ] Commit message describes exact changes

---

### Phase 2: Token Budget Fix (MEDIUM Task)

**Task Size**: MEDIUM (1 file split into 5 files)

#### Pre-Flight Checklist

- [ ] Read CLAUDE.md completely
- [ ] Identify logical sections for splitting
- [ ] Create target file structure
- [ ] Verify documentation links won't break
- [ ] Plan reference updates

#### Content Split Checklist

- [ ] Create docs/DEVELOPMENT-GUIDE.md (workflow, testing, commands)
- [ ] Create docs/ARCHITECTURE-OVERVIEW.md (3-layer architecture, components)
- [ ] Create docs/PHANTOM-APIS.md (16 phantom APIs warning)
- [ ] Create docs/KNOWN-ISSUES.md (test status, limitations)
- [ ] Reduce CLAUDE.md to 150-200 lines (quick reference only)

#### New CLAUDE.md Structure

1. Project summary (10 lines)
2. Global rules reference (20 lines)
3. Quick start (30 lines)
4. Security warnings (20 lines)
5. Common operations (30 lines)
6. Links to detailed docs (20 lines)
7. Emergency procedures (20 lines)

**Target**: 150 lines (40% under limit, leaves headroom)

#### Persona Validation

- [ ] **Developer**: Easy to find information
- [ ] **Tester**: Clear testing instructions
- [ ] **QA**: No information lost, just reorganized
- [ ] **Logic**: Logical file organization
- [ ] **Vulnerability Researcher**: Security info prominent

#### Completion Gates

- [ ] CLAUDE.md ≤ 250 lines (target: 150)
- [ ] All content preserved (no deletions)
- [ ] Links between files work
- [ ] README.md references updated
- [ ] Local token budget check passes

---

## Test-First Approach

### YAML Fixes

**Tests**:

1. Run `yamllint .github/workflows/` locally BEFORE commit
2. Verify exit code 0 (no errors)
3. Check warnings reduced/eliminated

### Token Budget Fix

**Tests**:

1. Count lines: `wc -l CLAUDE.md` (must be ≤250)
2. Verify all files exist: `ls docs/DEVELOPMENT-GUIDE.md` etc.
3. Check links work: `grep -r "docs/" CLAUDE.md`
4. Run local token budget validation script (if exists)

---

## Risk Assessment

### YAML Fixes

- **Risk**: VERY LOW
- **Reversibility**: IMMEDIATE (git revert)
- **Blast Radius**: 2 lines, whitespace only
- **Failure Mode**: YAML syntax error (caught by linter)

### Token Budget Fix

- **Risk**: LOW-MEDIUM
- **Reversibility**: IMMEDIATE (git revert)
- **Blast Radius**: 6 files (1 modified, 5 new)
- **Failure Mode**: Broken links, missing content
- **Mitigation**: Keep all content, only reorganize

---

## Execution Order

1. **Phase 1: YAML Lint Fixes** (15 min)
   - Low risk, high confidence
   - Unblocks 1 of 2 failing checks
   - Quick win

2. **Phase 2: Token Budget Fix** (45 min)
   - Higher complexity, more validation needed
   - Unblocks final failing check
   - Requires careful testing

**Total Estimated Time**: 60 minutes
**Expected Result**: 100% CI/CD passing

---

## Success Criteria

### Phase 1 Complete

- [ ] YAML Lint workflow: ✅ PASSING
- [ ] Only 2 lines modified
- [ ] No new errors introduced

### Phase 2 Complete

- [ ] Token Budget workflow: ✅ PASSING
- [ ] CLAUDE.md ≤ 250 lines
- [ ] All content preserved
- [ ] Documentation links working

### Final Success

- [ ] ALL CI/CD workflows: ✅ PASSING
- [ ] No regressions in previously passing checks
- [ ] Code quality maintained
- [ ] Security posture unchanged

---

## Rollback Plan

**If anything fails**:

```bash
# Immediate rollback
git revert HEAD

# Or hard reset (use with caution)
git reset --hard origin/main
```

**Recovery time**: < 1 minute

---

**Created**: 2025-10-28
**Owner**: Chrome Dev Assist Team
**Status**: Ready to Execute
