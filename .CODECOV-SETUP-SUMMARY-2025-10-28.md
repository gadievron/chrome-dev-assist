# Codecov Global Setup Summary

**Date**: 2025-10-28
**Project**: chrome-dev-assist (and ALL future projects)
**Setup Type**: Global infrastructure + OIDC authentication

---

## ‚úÖ What Was Accomplished

### Global Infrastructure Created

**Templates** (`~/.claude/templates/`):

1. `codecov.yml` - Global Codecov configuration
2. `workflows/test-coverage-codecov.yml` - Node.js/JavaScript workflow
3. `workflows/test-coverage-python.yml` - Python workflow

**Scripts** (`~/.claude/scripts/`): 4. `setup-codecov.sh` - Automated setup script (works for nodejs, python, go, rust)

**Documentation** (`~/.claude/docs/`): 5. `CODECOV-SETUP.md` - Comprehensive 800+ line guide covering:

- OIDC vs token-based comparison
- Setup for all project types
- Configuration options
- Troubleshooting
- Best practices
- FAQ

**Global README Updated**: 6. Added Codecov section to `~/.claude/README.md`

### Project-Specific Setup (chrome-dev-assist)

**Files Created/Updated**:

1. `.codecov.yml` - Coverage configuration (80% target, 2% threshold)
2. `.github/workflows/test-coverage.yml` - Upgraded to v5 with OIDC

**Key Changes**:

```yaml
# Added OIDC permissions
permissions:
  id-token: write      # REQUIRED for OIDC
  contents: read
  pull-requests: write

# Upgraded to v5 with OIDC
- uses: codecov/codecov-action@v5
  with:
    use_oidc: true     # NO TOKEN NEEDED!
```

**Dependabot PR**:

- Closed PR #4 (codecov-action v4‚Üív5)
- Reason: Already upgraded with OIDC directly

---

## üéØ Modern Approach: OIDC Authentication

### What is OIDC?

**OpenID Connect (OIDC)** is a modern authentication protocol that allows GitHub and Codecov to trust each other without sharing secrets.

**How it works:**

1. Workflow requests coverage upload
2. GitHub generates short-lived token (expires in minutes)
3. Codecov verifies token with GitHub
4. Upload proceeds securely

**Benefits:**

- ‚úÖ **No secrets** - No CODECOV_TOKEN in GitHub secrets
- ‚úÖ **Automatic** - GitHub handles everything
- ‚úÖ **Secure** - Tokens can't leak (expire quickly)
- ‚úÖ **Simple** - Just add `use_oidc: true`

### Old Way (v4 - Token-Based)

```yaml
# ‚ùå Old approach (requires secrets)
- uses: codecov/codecov-action@v4
  with:
    token: ${{ secrets.CODECOV_TOKEN }} # Manual secret management
```

**Problems:**

- Must create Codecov account ‚Üí Get token ‚Üí Add to GitHub secrets
- Different token per repo
- Tokens can leak or expire
- Manual rotation required

### New Way (v5 - OIDC)

```yaml
# ‚úÖ New approach (no secrets!)
permissions:
  id-token: write  # Allow GitHub to generate OIDC tokens

- uses: codecov/codecov-action@v5
  with:
    use_oidc: true  # That's it!
```

**Benefits:**

- No secrets to manage
- Works immediately after activating repo on Codecov.io
- Same setup for ALL repos
- More secure

---

## üì¶ What Each File Does

### `.codecov.yml` (Coverage Configuration)

Controls coverage behavior:

```yaml
coverage:
  status:
    project:
      default:
        target: 80% # Minimum coverage required
        threshold: 2% # Allow 2% drop from target

ignore:
  - 'tests/**/*' # Don't count test files in coverage
  - '**/node_modules/**'

comment:
  layout: 'reach,diff,flags,tree,footer' # PR comment format
```

**Key settings:**

- **Target**: 80% (fail if coverage < 80%)
- **Threshold**: 2% (allow temporary drops)
- **Ignore**: Tests, dependencies, build artifacts

### `.github/workflows/test-coverage.yml` (CI/CD Workflow)

Runs tests and uploads coverage:

```yaml
permissions:
  id-token: write # REQUIRED for OIDC
  contents: read
  pull-requests: write

jobs:
  test-coverage:
    steps:
      - run: npm test -- --coverage

      - uses: codecov/codecov-action@v5
        with:
          use_oidc: true
          files: ./coverage/lcov.info
```

**Runs on:**

- Every push to main
- Every PR to main

**Does:**

1. Runs tests with coverage
2. Uploads to Codecov (OIDC)
3. Creates coverage artifact
4. Comments on PR with results

---

## üöÄ Using in Future Projects

### Quick Start (3 commands)

```bash
# 1. Run setup script
cd /path/to/new/project
~/.claude/scripts/setup-codecov.sh nodejs

# 2. Activate on Codecov.io
# Visit: https://about.codecov.io/sign-up/
# Sign in ‚Üí Grant access ‚Üí Find repo ‚Üí Activate

# 3. Commit and push
git add .codecov.yml .github/workflows/test-coverage.yml
git commit -m "Add Codecov integration with OIDC"
git push
```

Coverage uploads automatically on next CI run!

### Supported Project Types

**Node.js / JavaScript:**

```bash
~/.claude/scripts/setup-codecov.sh nodejs
```

**Python:**

```bash
~/.claude/scripts/setup-codecov.sh python
```

**Others:**

- Templates available for Go, Rust, etc.
- Customize from `~/.claude/templates/workflows/`

---

## üìä Codecov.io Account Setup

### One-Time Setup (Per User, Not Per Repo)

**Step 1: Sign Up**

1. Go to: https://about.codecov.io/sign-up/
2. Click "Sign up with GitHub"
3. Authorize Codecov

**Step 2: Grant Access**
Choose:

- **All repositories** (easiest) - Codecov can see all your repos
- **Specific repositories** (more secure) - Grant access one at a time

**Step 3: Activate Repository**

1. Find your repo in Codecov dashboard
2. Click "Activate" or "Enable"
3. Done! (No token needed with OIDC)

### Per-Repository Setup

**After activating on Codecov.io:**

1. Push code with workflow ‚Üí Coverage uploads automatically
2. Check GitHub Actions logs for "‚úÖ Upload successful"
3. Visit Codecov dashboard to see coverage

**No configuration needed** - OIDC trust is automatic!

---

## üõ†Ô∏è Configuration Options

### Coverage Thresholds

**Strict (90%+ for mature projects):**

```yaml
coverage:
  status:
    project:
      default:
        target: 90%
        threshold: 1% # Strict - allow only 1% drop
```

**Moderate (80%+ for most projects):**

```yaml
coverage:
  status:
    project:
      default:
        target: 80%
        threshold: 2% # Balanced
```

**Lenient (70%+ for legacy/experimental):**

```yaml
coverage:
  status:
    project:
      default:
        target: 70%
        threshold: 5% # Flexible
```

### PR Comments

**Detailed (show full diff):**

```yaml
comment:
  layout: 'reach,diff,flags,tree,footer'
  behavior: default
```

**Minimal (only summary):**

```yaml
comment:
  layout: 'reach,footer'
  behavior: once
```

**Disabled:**

```yaml
comment: false
```

### Ignore Paths

**Common patterns:**

```yaml
ignore:
  - 'tests/**/*' # Test files
  - '**/*.test.js' # Jest tests
  - '**/node_modules/**' # Dependencies
  - '**/coverage/**' # Coverage reports
  - '**/dist/**' # Build output
```

---

## üîß Troubleshooting

### "OIDC token not found"

**Cause**: Missing `permissions: id-token: write`

**Fix:**

```yaml
permissions:
  id-token: write
  contents: read
```

### "Repository not found on Codecov"

**Cause**: Repository not activated on Codecov.io

**Fix:**

1. Go to https://app.codecov.io/
2. Find your repo
3. Click "Activate"

### Coverage Shows 0%

**Cause**: Coverage file not found

**Fix:**

```bash
# Verify coverage file exists
ls coverage/lcov.info

# Check workflow points to correct file
# files: ./coverage/lcov.info
```

### PR Comments Not Appearing

**Cause**: Missing `pull-requests: write` permission

**Fix:**

```yaml
permissions:
  pull-requests: write
```

---

## üìà Benefits vs Traditional Token Approach

| Feature                | OIDC (v5)           | Token (v4)           |
| ---------------------- | ------------------- | -------------------- |
| **Setup complexity**   | ‚úÖ Simple (1 line)  | ‚ùå Complex (3 steps) |
| **Secrets management** | ‚úÖ None             | ‚ùå Manual            |
| **Security**           | ‚úÖ Temporary tokens | ‚ö†Ô∏è Long-lived tokens |
| **Rotation**           | ‚úÖ Automatic        | ‚ùå Manual            |
| **Leak risk**          | ‚úÖ Very low         | ‚ö†Ô∏è Medium            |
| **Works for forks**    | ‚úÖ Yes              | ‚ö†Ô∏è Requires secrets  |
| **Multi-repo setup**   | ‚úÖ Instant          | ‚ùå Per-repo tokens   |

**Recommendation**: Always use OIDC for GitHub Actions workflows.

---

## üéì Best Practices

### 1. Set Realistic Targets

- New projects: 70% ‚Üí 80% over time
- Mature projects: 80-90%
- Don't aim for 100% (tests need tests!)

### 2. Ignore Appropriate Files

- ‚úÖ Tests (they test code, not tested themselves)
- ‚úÖ Config files
- ‚úÖ Generated code
- ‚ùå Don't ignore actual source code

### 3. Use Flags for Organization

```yaml
flags: frontend,unit      # Frontend unit tests
flags: backend,integration # Backend integration tests
```

### 4. Monitor Trends

- Check weekly for coverage drops
- Set up Codecov notifications
- Review PRs with coverage impact

### 5. Don't Obsess Over Percentages

- 80% with good tests > 100% with bad tests
- Focus on testing critical paths
- Use coverage to find gaps, not as a goal

---

## üìö Documentation

**Quick reference:**

- This file (project summary)
- `~/.claude/docs/CODECOV-SETUP.md` (complete guide)
- `~/.claude/README.md` (global commands overview)

**Official resources:**

- Codecov docs: https://docs.codecov.com/
- OIDC guide: https://docs.codecov.com/docs/github-oidc
- GitHub Actions: https://docs.github.com/en/actions

---

## ‚úÖ Verification Checklist

**Global infrastructure:**

- [x] Templates created (`~/.claude/templates/`)
- [x] Setup script created (`~/.claude/scripts/setup-codecov.sh`)
- [x] Documentation created (`~/.claude/docs/CODECOV-SETUP.md`)
- [x] README updated (`~/.claude/README.md`)

**chrome-dev-assist project:**

- [x] `.codecov.yml` created
- [x] Workflow upgraded to v5 with OIDC
- [x] Dependabot PR #4 closed
- [x] Changes committed and pushed

**Next steps:**

- [ ] Activate chrome-dev-assist on Codecov.io
- [ ] Verify coverage upload on next push
- [ ] Add coverage badge to README (optional)

---

## üéØ Expected Results

**After activating on Codecov.io:**

- ‚úÖ Coverage uploads automatically on every push/PR
- ‚úÖ PR comments with coverage diff
- ‚úÖ Coverage trends tracked over time
- ‚úÖ Coverage badges available
- ‚úÖ No secrets to manage
- ‚úÖ Works for all contributors (including forks)

**Coverage tracking:**

- View at: https://app.codecov.io/gh/gadievron/chrome-dev-assist
- Badge: `[![codecov](https://codecov.io/gh/gadievron/chrome-dev-assist/branch/main/graph/badge.svg)](https://codecov.io/gh/gadievron/chrome-dev-assist)`

---

## üöÄ Next Projects

**For every new project:**

```bash
cd /new/project
~/.claude/scripts/setup-codecov.sh nodejs  # or python, go, etc.
# Commit, push, activate on Codecov.io
# Done!
```

**One-time Codecov.io setup** already done (GitHub account linked).

**All future projects:**

- Use global templates (instantly consistent)
- OIDC authentication (no secrets)
- Same workflow across all repos

---

**Setup complete!** üéâ

All future projects can now use Codecov with a single command.

**Files to reference:**

- Setup script: `~/.claude/scripts/setup-codecov.sh`
- Complete guide: `~/.claude/docs/CODECOV-SETUP.md`
- This summary: `.CODECOV-SETUP-SUMMARY-2025-10-28.md`
